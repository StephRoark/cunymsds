---
title: 'Final Project - Seattleâ€™s Perfect Weekend: Fact or Fiction?'
author: "Stephanie Roark"
date: "12/9/2018"
output: html_document
---

#Seattle's Perfect Summer: Fact or Fiction?

The weather in the Pacific Northwest is notoriusly rainy and gloomy, but the summers are gloriously full of perfect weather, or at least that's what we believe. How many days are actually perfect?

To answer this question, we must first think about what a perfect day means. The temperature should be warm, but not hot and the sun should be shining most if not all of the day. So we can define a perfect day as being between a certain range of temperatures, say between 60 degrees F and 80 degrees F, and little to no precipitation. When defining a perfect day, the precipitation can't be assumed to be zero because we will often have a small sprinkle over night, but then beautiful blue-skyed days.

We will start our data collection at NOAA and the EPA.

The NOAA website has available a weather dataset measured at Seattle-Tacoma Airport (SeaTac) spanning all the way back to 1948 containing 50 variables including both max and min temperature and precipitation data and is available for download here: [Seattle Daily]("https://www.ncdc.noaa.gov/cdo-web/datasets/GHCND/stations/GHCND:USW00024233/detail")

The EPA has a pre-generated air quality dataset which contains the air quality index by day for every county in the US and spanning from 01.01.1980 to 11.27.2018: [AQI]("https://aqs.epa.gov/aqsweb/airdata/download_files.html")

##Data

Let's start by loading the datasets and taking a look at their structure.

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE)
library(tidyverse)
library(knitr)
library(lubridate)
library(chron)
library(rvest)
```

Load the Seattle weather data:

```{r SEAWeather}
SeattleWeather <- readr::read_csv("SeattleWeather_1948_2017.csv")
kable(head(SeattleWeather))
kable(tail(SeattleWeather))
str(SeattleWeather)
```

Seattle weather is a dataframe with 25551 observations of 5 variables which are `r colnames(SeattleWeather)`. Each observation represents a single day's meausurements.

TMAX and TMIN are integers representing the maximum and minimum temperatures recorded for that day. RAIN is a logical vector which is true if there is 0.01 inches of rain and false if there is 0.0 inches precipitation whereas PRCP is a numeric representing the amount of daily precipitation measured in inches. DATE is already a date factor so it won't need to be transformed.

Next we must consider air quality as the recent wildfires on the west coast have greatly impacted everyone's ability to safely go outside and a good air quality rating should be factored into our definition of a perfect day. 

We load each year of AQI data from 1980 to present, filtering for only Seattle, King County, Washington, and then create a single data frame for all the years of data.

```{r load AQIdata}

#data_list <- list()
#for(year in 1980:2018) {
#    temp <- tempfile()
#    base_file_name <- paste0("daily_aqi_by_county_",year)
#    url_name <- paste0("https://aqs.epa.gov/aqsweb/airdata/",base_file_name,".zip")
#    csv_name <- paste0(base_file_name,".csv")
#    download.file(url_name,temp)
#    data <- read_csv(unz(temp, csv_name)) %>%
#        filter(`State Name` == "Washington" & `county Name` == "King")
#    data_list[[year]] <- data
#    unlink(temp)
#}
#AQIdata <- do.call("rbind", data_list)

AQIdata <- readr::read_csv("AQI_KING.csv")
kable(head(AQIdata))
kable(tail(AQIdata))
str(AQIdata)
```

The AQI or air quality index data set consists of 14090 observations of 10 variables including `r colnames(AQIdata)`. Each observation represents a single day's meausurements. The Date and Category variables are of interest in determining which days had acceptable air quality in Seattle. Once again the Date was read in as a date factor and category is a character.

So now we have 2 dataframes with temperature, precipitation and air quality included. The next step is to combine these dataframes into one table.

Since our AQI dataset only contains data from 1980, we will only have concurrent dates beginning from 01.01.1980 and going to 12.14.2017 which is when the Seattle Weather Data Ends.

```{r join}

### inner join on the dates available
AllWeather <- inner_join(SeattleWeather, AQIdata, by = c("DATE" = "Date"))

#look at how the new table is structured
str(AllWeather)

#look at the numberic values
#kable(AllWeather %>%
#    select_if(is.numeric) %>%
#    skimr::skim())

kable(AllWeather %>%
    select_if(is.numeric) %>%
    skimr::skim(AQI))

kable(AllWeather %>%
    select_if(is.numeric) %>%
    skimr::skim(TMAX))

kable(AllWeather %>%
    select_if(is.numeric) %>%
    skimr::skim(TMIN))

kable(AllWeather %>%
    select_if(is.numeric) %>%
    skimr::skim(PRCP))

#how many NA's are in the new table
sum(is.na(AllWeather))

```

Now that we have our two datasets joined together, let's take a look at the max and min temp ranges for each year with air quality.

```{r airqualityindex_plot,fig.width=7,fig.height=21}
#plot tmin and tmax against date - color green for good days and red for bad
AllWeather %>% #filter(year(DATE) < 1985 ) %>%
    mutate(year = year(DATE), day_of_year = yday(DATE) ) %>%
    ggplot(aes(x=day_of_year, ymin=TMIN, ymax=TMAX, colour=AQI)) +
    geom_linerange(size=0.5) +
    scale_colour_gradient2(low = "green", mid="yellow", high = "red", midpoint = 100) +
    # 125 is the midpoint of the "Unhealthy for Sensitive Groups" level
    # 100 is the transition point from "Moderate" to "Unhealthy for Sensitive Groups"
    facet_grid( year ~ .) +
    xlab("Day of Year") + ylab("Temp (F, min to max)") +
    ggtitle("Maximum and Minimum Temperature with Air Quality from 1980 to 2017") +
    theme_minimal()

```

From the plots we can see that air quality tends to be an issue in the summer time. The temperature range is pretty consistent throughout the year.

And now the precipitation by day for each year. 

```{r rain_plot,fig.width=7,fig.height=21}
AllWeather %>% 
    mutate(year = year(DATE), day_of_year = yday(DATE) ) %>%
    ggplot(aes(x=day_of_year, y=PRCP)) +
    geom_bar(stat="identity") +
    facet_grid( year ~ .) +
    xlab("Day of Year") + ylab("Precipitation (inches)") +
    coord_cartesian(ylim = c(0, 1)) +
    scale_y_continuous(breaks=c(0,0.5,1)) +
    ggtitle("Precipitation from 1980 to 2017") +
    theme_classic()

```

There are definite gaps in the precipitation each year which makes sense as the summers tend to be very dry. It is interesting to see how the dry weather gaps do not occur consistently at the same time of year.

So, now that we have visualized the weather and air quality in Seattle, we can begin to define what perfect weather is. We can select a "perfect" temperature range, let's say only the days with TMIN and TMAX between 60 and 80 degrees F, and also days with no rain. We can assume that given this temperature range, the precipitation that falls will be rain rather than snow. One approach to selecting would be to filter the dataset for RAIN being FALSE, but this does not allow for any precipitation at all. Instead,let's consider the PCRP variable which is inches of rain measured in a day. We can filter for precipitation less than a certain amount of rain in inches to account for the common occurence of rain over night and this approach will allow for sensitivity testing of edge perfect days. The data may be sensitive close to the ranges that we select, so we will want to examine the data near our range to see if there is a great difference in perfect days.

```{r temprange}
#let's first look at the number of days in the 60-80 degree range
SeattleWeather_TempRange6080 <- AllWeather %>%
    filter(TMAX <= 80 & TMIN >= 60)
count(SeattleWeather_TempRange6080)

#now let's widen the range to  55-85 degree range
SeattleWeather_TempRange5585 <- AllWeather %>%
    filter(TMAX <= 85 & TMIN >= 55)
count(SeattleWeather_TempRange5585)
```

Temp Range (F)  |          Days within Temp Range        | Percentage                                                   
--------------- | -------------------------------------- | -------------------------------------------------------------------
        60 - 80 | `r count(SeattleWeather_TempRange6080)`| `r round(count(SeattleWeather_TempRange6080)/nrow(AllWeather)*100, 2)`%
        55 - 85 | `r count(SeattleWeather_TempRange5585)`| `r round(count(SeattleWeather_TempRange5585)/nrow(AllWeather)*100, 2)`%

          

There's a vast difference in the percentage of days between the temp range of 60 and 80 which is `r round(count(SeattleWeather_TempRange6080)/nrow(AllWeather)*100, 2)`%, and between 55 and 85 which is `r round(count(SeattleWeather_TempRange5585)/nrow(AllWeather)*100, 2)`%. We will go with the later because some people might be a little less sensitive to the temperature range and we can consider more possible perfect days.

Filtering for precipitation range:

```{r preciprange}
#total number of days in the data set
nrow(AllWeather)

###how many days with rain less than 0.01
SeattleWeather_noRain0.01 <- AllWeather %>%
    filter(PRCP <= 0.01)
count(SeattleWeather_noRain0.01)

###how many days with rain less than 0.01
SeattleWeather_noRain0.03 <- AllWeather %>%
    filter(PRCP <= 0.03)
count(SeattleWeather_noRain0.03)

###how many days with rain less than 0.05
SeattleWeather_noRain0.05 <- AllWeather %>%
    filter(PRCP <= 0.05)
count(SeattleWeather_noRain0.05)

###or days with rain less than 0.1
SeattleWeather_noRain0.1 <- AllWeather %>%
    filter(PRCP <= 0.1)
count(SeattleWeather_noRain0.1)
```


Rain Amount(In) |           Days with Rain           | Percentage                                                   
--------------- | ---------------------------------- | -------------------------------------------------------------------
           0.01 |`r count(SeattleWeather_noRain0.01)`| `r round((count(SeattleWeather_noRain0.01)/nrow(AllWeather))*100,2)`%
           0.03 |`r count(SeattleWeather_noRain0.03)`| `r round((count(SeattleWeather_noRain0.03)/nrow(AllWeather))*100,2)`%
           0.05 |`r count(SeattleWeather_noRain0.05)`| `r round((count(SeattleWeather_noRain0.05)/nrow(AllWeather))*100,2)`%
           


The percentage of days with less than or equal to 0.01 inches of precipitation is `r round((count(SeattleWeather_noRain0.01)/nrow(AllWeather))*100,2)`%, 0.05 inches of precipitation is `r round((count(SeattleWeather_noRain0.05)/nrow(AllWeather))*100,2)`% while 0.1 is `r round((count(SeattleWeather_noRain0.1)/nrow(AllWeather))*100, 2)`%. There is much less sensitivity to days within the precipitation range, so we will go with the mid range.

Next, we need to choose only the dates where the air quality is listed as Moderate or Good.  We can use the Date and Category columns to filter for the moderate to good air quality days.

```{r prefect&AQI subsets}
PerfectWeather <- AllWeather %>%
    filter(TMAX <= 85 & TMIN >= 55) %>%
    filter(PRCP <= 0.05) %>%
    filter(AQI <= 100)

str(PerfectWeather)
```

Now we have one table containing `r nrow(PerfectWeather)` days where the weather falls in our defined temperature range with little to no rain and moderate or good air quality.

Let's take a look at the distribution of the perfect weather days.

```{r perfect weather table plot, fig.width=7,fig.height=21}
#plot tmin and tmax against date - color green for good days and red for bad
PerfectWeather %>% #filter(year(DATE) < 1985 ) %>%
    mutate(year = year(DATE), day_of_year = yday(DATE) ) %>%
    ggplot(aes(x=day_of_year, ymin=TMIN, ymax=TMAX)) +
    geom_linerange(size=0.5) +
    facet_grid( year ~ .) +
    xlab("Day of Year") + ylab("Temp (F, min to max)") + 
    ggtitle("Distribution of Perfect Weather Days from 1980 to 2017") +
    theme_minimal()
```

We see right away that 1980 and 1981 have fewer perfect days. Everyone in the Pacific Northwest recalls the events of May 18, 1980  when Mt. St. Helens erupted causing extremely poor air quality and possibly affecting the weather of those summers.


```{r plot}

#Kable(head())

#str()

# how many dates
#table()

#plot 
#plot()

```


Finally, let's compare the data over the range of years to find how many of these perfect days coincide with weekends or when festivals and events are happening in the area?

####Weekends

How many perfect days fall on weekends? It's a common myth here in the Seattle area that you know it's the weekend because it starts raining. Is it true that it rains more on the weekends?

```{r weekends}

temp_weekend <- PerfectWeather %>% mutate( weekendday = is.weekend(DATE) )

temp_filterweekend <- PerfectWeather %>% filter( is.weekend(DATE) )

temp_filterholiday <- PerfectWeather %>% filter( is.holiday(DATE) )

#is.holiday
```

####Events 
We need data on events in the area which we can obtain from Seattle Open Data:

[Seattle Special Events Data]("https://data.seattle.gov/Permitting/Special-Events-Permits/dm95-f8w5")


```{r events}
Seattle_events <- read_csv("Special_Events_Permits.csv")

```

This data set consists of 2677 observations of 15 different variables including `r colnames(Seattle_events)`. We will need to address some formatting issues with this data so that we can join the events dates with our weather data. First, the dates are organized as Event Start Date and Event End Date and these will need to be changed to a single date. Second, we need to choose which Event Categories are relevant to our analysis.


Stat analysis- is the summer different than the rest of the year 

H0 = summer is different 
H1 = summer is the same as the rest of the year

Is the number of summer perfect days/weekends different than the rest of the year? Has the number of perfect summer days decreased?

```{r perfect days change}

#statistical analysis
#plot perfect days/weekends changes?

```


